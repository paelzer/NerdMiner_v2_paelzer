#include "displayDriver.h"

#ifdef ESP32_S3_Zero_SSD1306
#include "version.h"
#include "monitor.h"
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Wire.h>

#define WIDTH 128
#define HEIGHT 64

#define OLED_RESET -1       // Reset pin # (or -1 if sharing Arduino reset pin)
#define SCREEN_ADDRESS 0x3C ///< See datasheet for Address; 0x3D for 128x64, 0x3C for 128x32

Adafruit_SSD1306 display(WIDTH, HEIGHT, &Wire, OLED_RESET);

// Splash Screen
static const unsigned char PROGMEM logo_bmp[] =
    {
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0xc7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x06, 0xc7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x3e, 0xe7, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x3c, 0xe7, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x07, 0x0f, 0x9c, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x03, 0x1d, 0xdc, 0x38, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x1e, 0x00, 0x00, 0x00, 0x01,
        0x81, 0xe3, 0x99, 0xcc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x1f, 0x00, 0x00, 0x00, 0x01,
        0x81, 0xf3, 0x9f, 0xce, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x8f, 0x00, 0x00, 0x00, 0x01,
        0x80, 0xf9, 0x9e, 0x0e, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x7f, 0xc6, 0x00, 0x00, 0x00, 0x01,
        0x80, 0xff, 0xdc, 0xe0, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x01,
        0x80, 0xef, 0xcf, 0xc0, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x07, 0xf8, 0x00, 0x30, 0x00, 0x01,
        0x80, 0x67, 0xe7, 0x00, 0x00, 0x00, 0x03, 0xe7, 0x00, 0x00, 0x03, 0xfc, 0x07, 0xff, 0x00, 0x01,
        0x80, 0x71, 0xe0, 0x00, 0x00, 0x00, 0x07, 0x77, 0x00, 0x00, 0x00, 0xfe, 0x1f, 0xff, 0xe0, 0x01,
        0x80, 0x30, 0xe0, 0x00, 0x00, 0x00, 0xc6, 0x73, 0x00, 0x00, 0x00, 0x7f, 0x3e, 0x01, 0xf0, 0x01,
        0x80, 0x38, 0x00, 0x00, 0x01, 0xc1, 0xf7, 0xf3, 0x80, 0x00, 0x0e, 0x3f, 0xb8, 0x00, 0x7c, 0x01,
        0x80, 0x38, 0x00, 0x00, 0x01, 0x8f, 0xf7, 0x83, 0x80, 0x00, 0x1f, 0x1f, 0x81, 0xfe, 0x1e, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x38, 0x0f, 0x3f, 0x38, 0x00, 0x00, 0x1f, 0x8f, 0xc7, 0xff, 0x8e, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x78, 0xe7, 0x3b, 0xf0, 0x00, 0x00, 0x3f, 0x07, 0xcf, 0xff, 0xe7, 0x01,
        0x80, 0x00, 0x00, 0x04, 0x7c, 0xe7, 0x19, 0xc0, 0x00, 0x00, 0x7e, 0x03, 0xef, 0xff, 0xf3, 0x81,
        0x80, 0x00, 0x00, 0x1e, 0x7c, 0x73, 0x1c, 0x00, 0x00, 0x00, 0xfe, 0x0d, 0xef, 0xff, 0xf9, 0x81,
        0x80, 0x00, 0x00, 0x1e, 0x7e, 0x73, 0x90, 0x00, 0x00, 0x01, 0xfc, 0x0c, 0xef, 0xdb, 0xf9, 0xc1,
        0x80, 0x00, 0x00, 0x1f, 0x3e, 0x33, 0x80, 0x00, 0x00, 0x01, 0xf8, 0x1c, 0x6e, 0x13, 0xfc, 0xc1,
        0x80, 0x00, 0x00, 0x1f, 0xb7, 0x38, 0x00, 0x00, 0x00, 0x03, 0xf0, 0x1c, 0xbf, 0x03, 0xfc, 0xe1,
        0x80, 0x00, 0x00, 0x0d, 0xf7, 0x38, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x19, 0x8f, 0x18, 0xfe, 0xe1,
        0x80, 0x00, 0x00, 0x0c, 0xf3, 0x80, 0x00, 0x40, 0x00, 0x0f, 0xe0, 0x19, 0xdf, 0x3c, 0xfe, 0x61,
        0x80, 0x00, 0x00, 0x0e, 0xf3, 0x00, 0x00, 0xc0, 0x00, 0x0f, 0xc0, 0x19, 0xff, 0x3c, 0xfe, 0x61,
        0x80, 0x00, 0x00, 0x06, 0x70, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x39, 0xff, 0x01, 0xfe, 0x61,
        0x80, 0x00, 0x00, 0x06, 0x20, 0x00, 0x00, 0x20, 0xc0, 0x3f, 0x00, 0x39, 0xfe, 0x31, 0xfe, 0x61,
        0x80, 0x00, 0x00, 0x07, 0x00, 0x00, 0x06, 0x33, 0x80, 0x7f, 0x00, 0x19, 0xfe, 0x78, 0xfe, 0x61,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x02, 0x0f, 0xb0, 0x00, 0xfe, 0x00, 0x19, 0xf8, 0x78, 0xfe, 0x61,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x06, 0x39, 0x98, 0x00, 0xfc, 0x00, 0x19, 0xf8, 0x11, 0xfe, 0xe1,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xd8, 0x01, 0xf8, 0x00, 0x1c, 0xfe, 0x01, 0xfc, 0xe1,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x30, 0xcc, 0x03, 0xf8, 0x00, 0x1c, 0xfe, 0xdf, 0xfc, 0xc1,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x98, 0x6c, 0x03, 0xf0, 0x00, 0x0e, 0x7f, 0x9f, 0xf9, 0xc1,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x31, 0x98, 0x60, 0x01, 0xe0, 0x00, 0x0e, 0x7f, 0xff, 0xf3, 0x81,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x7c, 0xcc, 0x00, 0x00, 0xc0, 0x00, 0x07, 0x3f, 0xff, 0xf3, 0x81,
        0x80, 0x00, 0x00, 0x00, 0x03, 0x4c, 0xcc, 0x00, 0x00, 0x00, 0x00, 0x03, 0x9f, 0xff, 0xc7, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x07, 0xc6, 0x60, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc7, 0xff, 0x8e, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x1c, 0xc6, 0x60, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe1, 0xfe, 0x1c, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x18, 0xc3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x78, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x18, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x03, 0xf0, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x0c, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xc0, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x6c, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x01, 0xc6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};

void ssd1306_Display_Init(void)
{
  Wire.setPins(8, 9); // I2C pins of the ESP32 super mini  I have tested with - there might be differences

  // SSD1306_SWITCHCAPVCC = generate display voltage from 3.3V internally
  if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS))
  {
    // Serial.println(F("SSD1306 allocation failed"));
    for (;;)
      ; // Don't proceed, loop forever
  }

  display.clearDisplay();

  // Draw the splash screen
  display.drawBitmap(
      (display.width() - WIDTH) / 2,
      (display.height() - HEIGHT) / 2,
      logo_bmp, WIDTH, HEIGHT, 1);
  display.display();

  delay(2000);

  // Invert and restore display, pausing in-between (short animation)
  for (int i = 0; i <= 10; i++)
  {
    display.invertDisplay(true);
    delay(25);
    display.invertDisplay(false);
    delay(25);
  }

  // Clear the buffer
  display.clearDisplay();
}

void ssd1306_Display_AlternateScreenState(void)
{
  // tbd
}

void ssd1306_Display_AlternateRotation(void)
{
  display.setRotation((display.getRotation() + 2) % 4);
}

void ssd1306_Display_MinerScreen(unsigned long mElapsed)
{
  mining_data data = getMiningData(mElapsed);

  // Print background screen
  display.clearDisplay(); // paint it black :-)

  Serial.printf(">>> Completed %s share(s), %s Khashes, avg. hashrate %s KH/s\n",
                data.completedShares.c_str(), data.totalKHashes.c_str(), data.currentHashRate.c_str());

  // Hashrate
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE); // Draw white text
  display.setCursor(0, 0);
  // render.setFontColor(TFT_BLACK);

  display.print(data.currentHashRate.c_str());
  display.println(F(" kH/s"));
  display.setTextSize(1);
  display.println();

  // Valid Blocks
  display.setTextSize(2);
  display.print(data.valids.c_str());
  // display.setTextSize(1);
  display.println(F(" Blocks"));

  // Mining Time
  char timeMining[15];
  unsigned long secElapsed = millis() / 1000;
  int days = secElapsed / 86400;
  int hours = (secElapsed - (days * 86400)) / 3600;               // Number of seconds in an hour
  int mins = (secElapsed - (days * 86400) - (hours * 3600)) / 60; // Remove the number of hours and calculate the minutes.
  int secs = secElapsed - (days * 86400) - (hours * 3600) - (mins * 60);
  sprintf(timeMining, "%01d d %02d:%02d:%02d h", days, hours, mins, secs);
  display.setTextSize(1);
  display.println();
  display.println(String(timeMining).c_str());
  display.display();
}

// uint16_t osx=64, osy=64, omx=64, omy=64, ohx=64, ohy=64;  // Saved H, M, S x & y coords
void ssd1306_Display_ClockScreen(unsigned long mElapsed)
{
  clock_data_t data = getClockData_t(mElapsed);

  char clocktimeNow[8];
  uint8_t secs = data.currentSeconds;
  uint8_t mins = data.currentMinutes;
  uint8_t hours = data.currentHours;

  sprintf(clocktimeNow, "%02d:%02d:%02d", hours, mins, secs);

  display.clearDisplay();

  display.setTextSize(2);              // Normal 1:1 pixel scale
  display.setTextColor(SSD1306_WHITE); // Draw white text
  display.setCursor(0, 0);             // Start at top-left corner

  display.println(F(String(clocktimeNow).c_str()));

  display.display();
}

void ssd1306_Display_GlobalHashScreen(unsigned long mElapsed)
{
}

void ssd1306_Display_LoadingScreen(void)
{
}

void ssd1306_Display_SetupScreen(void)
{
}

void ssd1306_Display_AnimateCurrentScreen(unsigned long frame)
{
}

void ssd1306_Display_DoLedStuff(unsigned long frame)
{
}

CyclicScreenFunction ssd1306_DisplayCyclicScreens[] = {ssd1306_Display_MinerScreen, ssd1306_Display_ClockScreen};

DisplayDriver esp32_super_mini_SSD1306_driver = {
    ssd1306_Display_Init,
    ssd1306_Display_AlternateScreenState,
    ssd1306_Display_AlternateRotation,
    ssd1306_Display_LoadingScreen,
    ssd1306_Display_SetupScreen,
    ssd1306_DisplayCyclicScreens,
    ssd1306_Display_AnimateCurrentScreen,
    ssd1306_Display_DoLedStuff,
    SCREENS_ARRAY_SIZE(ssd1306_DisplayCyclicScreens),
    0,
    WIDTH,
    HEIGHT};
#endif
